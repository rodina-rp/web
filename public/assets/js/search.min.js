!function(){let searchInput=null,resultsContainer=null,noResults=null,loading=null,searchIndex=[];async function loadSearchIndex(){try{const response=await fetch("/web/search.json");return await response.json()}catch{return[]}}function findContext(text,query,chars=100){if(!text||!query)return text||"";const lowerText=text.toLowerCase(),lowerQuery=query.toLowerCase(),index=lowerText.indexOf(lowerQuery);if(-1===index)return text.substring(0,chars)+(text.length>chars?"...":"");const start=Math.max(0,index-30),end=Math.min(text.length,index+lowerQuery.length+70);let result=text.substring(start,end);return start>0&&(result="..."+result),end<text.length&&(result+="..."),result}function highlightText(text,query){if(!text||!query)return text;try{const escapedQuery=query.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),regex=new RegExp(`(${escapedQuery})`,"gi");return text.replace(regex,'<span class="bg-primary-red/30 text-white px-1 rounded">$1</span>')}catch{return text}}function cleanText(text){return text?text.replace(/\s+/g," ").trim():""}function fixUrl(url){const basePath="/web";return url.startsWith("/web/web")?url.replace("/web/web","/web"):url}async function performFullSearch(query){if(!query.trim())return resultsContainer.innerHTML="",noResults&&noResults.classList.remove("hidden"),void(loading&&loading.classList.add("hidden"));if(loading&&loading.classList.remove("hidden"),noResults&&noResults.classList.add("hidden"),resultsContainer.innerHTML="",searchIndex=await loadSearchIndex(),0===searchIndex.length)return resultsContainer.innerHTML='<div class="text-center py-8 text-gray-400">Индекс поиска не загружен</div>',void(loading&&loading.classList.add("hidden"));const normalizedQuery=query.toLowerCase().trim(),results=searchIndex.filter(item=>{const searchText=(item.title+" "+item.content).toLowerCase();return searchText.includes(normalizedQuery)});setTimeout(()=>{displayFullResults(results,query),loading&&loading.classList.add("hidden")},300)}function displayFullResults(results,query){resultsContainer.innerHTML="",0!==results.length?(noResults&&noResults.classList.add("hidden"),results.forEach(item=>{const card=document.createElement("div");card.className="bg-dark-bg/50 border border-primary-red/30 rounded-lg p-6 hover:border-primary-red/50 transition-colors";const cleanTitle=cleanText(item.title),cleanContent=cleanText(item.content),context=findContext(cleanContent,query,100),highlightedTitle=highlightText(cleanTitle,query),highlightedContent=highlightText(context,query),fixedUrl=fixUrl(item.url);card.innerHTML=`\n                <h3 class="text-xl font-bold mb-3" style="margin-top: 0;">\n                    <a href="${fixedUrl}" class="text-white hover:text-primary-red transition-colors">${highlightedTitle}</a>\n                </h3>\n                <div class="text-gray-400 mb-4">\n                    ${highlightedContent}\n                </div>\n                <a href="${fixedUrl}" class="inline-flex items-center text-primary-red hover:text-red-400 transition-colors">\n                    <span>Перейти к странице</span>\n                    <i class="fas fa-arrow-right ml-2"></i>\n                </a>\n            `,resultsContainer.appendChild(card)})):noResults&&noResults.classList.remove("hidden")}function handleInput(e){const query=e.target.value.trim();if(query){const newUrl=new URL(window.location);newUrl.searchParams.set("q",query),window.history.replaceState({},"",newUrl),performFullSearch(query)}else resultsContainer.innerHTML="",noResults&&noResults.classList.remove("hidden"),loading&&loading.classList.add("hidden")}function handleKeyPress(e){if("Enter"===e.key){const query=e.target.value.trim();if(query){const newUrl=new URL(window.location);newUrl.searchParams.set("q",query),window.location.href=newUrl.toString()}}}function initSearch(){if(searchInput=document.getElementById("full-search-input"),resultsContainer=document.getElementById("search-results"),noResults=document.getElementById("no-results"),loading=document.getElementById("loading"),!searchInput||!resultsContainer)return;const urlParams=new URLSearchParams(window.location.search),searchQuery=urlParams.get("q");searchQuery&&(searchInput.value=decodeURIComponent(searchQuery),performFullSearch(searchQuery)),searchInput.addEventListener("input",handleInput),searchInput.addEventListener("keypress",handleKeyPress)}void 0===window.RODINA&&(window.RODINA={}),window.RODINA.search={init:initSearch,performSearch:performFullSearch},"loading"!==document.readyState?initSearch():document.addEventListener("DOMContentLoaded",initSearch)}();